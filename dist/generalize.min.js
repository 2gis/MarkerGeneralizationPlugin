L.RbushSrc=function(){"use strict";function e(t,r){return this instanceof e?(this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),r&&this._initFormat(r),void this.clear()):new e(t,r)}function t(e,t){e.bbox=r(e,0,e.children.length,t)}function r(e,t,r,n){for(var o,a=i(),h=t;r>h;h++)o=e.children[h],s(a,e.leaf?n(o):o.bbox);return a}function i(){return[1/0,1/0,-(1/0),-(1/0)]}function s(e,t){return e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.max(e[2],t[2]),e[3]=Math.max(e[3],t[3]),e}function n(e,t){return e.bbox[0]-t.bbox[0]}function o(e,t){return e.bbox[1]-t.bbox[1]}function a(e){return(e[2]-e[0])*(e[3]-e[1])}function h(e){return e[2]-e[0]+(e[3]-e[1])}function l(e,t){return(Math.max(t[2],e[2])-Math.min(t[0],e[0]))*(Math.max(t[3],e[3])-Math.min(t[1],e[1]))}function c(e,t){var r=Math.max(e[0],t[0]),i=Math.max(e[1],t[1]),s=Math.min(e[2],t[2]),n=Math.min(e[3],t[3]);return Math.max(0,s-r)*Math.max(0,n-i)}function u(e,t){return e[0]<=t[0]&&e[1]<=t[1]&&t[2]<=e[2]&&t[3]<=e[3]}function m(e,t){return t[0]<=e[2]&&t[1]<=e[3]&&t[2]>=e[0]&&t[3]>=e[1]}function f(e,t,r,i,s){for(var n,o=[t,r];o.length;)r=o.pop(),t=o.pop(),i>=r-t||(n=t+Math.ceil((r-t)/i/2)*i,p(e,t,r,n,s),o.push(t,n,n,r))}function p(e,t,r,i,s){for(var n,o,a,h,l,c,u,m,f;r>t;){for(r-t>600&&(n=r-t+1,o=i-t+1,a=Math.log(n),h=.5*Math.exp(2*a/3),l=.5*Math.sqrt(a*h*(n-h)/n)*(0>o-n/2?-1:1),c=Math.max(t,Math.floor(i-o*h/n+l)),u=Math.min(r,Math.floor(i+(n-o)*h/n+l)),p(e,c,u,i,s)),m=e[i],o=t,f=r,_(e,t,i),s(e[r],m)>0&&_(e,t,r);f>o;){for(_(e,o,f),o++,f--;s(e[o],m)<0;)o++;for(;s(e[f],m)>0;)f--}0===s(e[t],m)?_(e,t,f):(f++,_(e,f,r)),i>=f&&(t=f+1),f>=i&&(r=f-1)}}function _(e,t,r){var i=e[t];e[t]=e[r],e[r]=i}return e.prototype={all:function(){return this._all(this.data,[])},search:function(e){var t=this.data,r=[],i=this.toBBox;if(!m(e,t.bbox))return r;for(var s,n,o,a,h=[];t;){for(s=0,n=t.children.length;n>s;s++)o=t.children[s],a=t.leaf?i(o):o.bbox,m(e,a)&&(t.leaf?r.push(o):u(e,a)?this._all(o,r):h.push(o));t=h.pop()}return r},collides:function(e){var t=this.data,r=this.toBBox;if(!m(e,t.bbox))return!1;for(var i,s,n,o,a=[];t;){for(i=0,s=t.children.length;s>i;i++)if(n=t.children[i],o=t.leaf?r(n):n.bbox,m(e,o)){if(t.leaf||u(e,o))return!0;a.push(n)}t=a.pop()}return!1},load:function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0,r=e.length;r>t;t++)this.insert(e[t]);return this}var i=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var s=this.data;this.data=i,i=s}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},insert:function(e){return e&&this._insert(e,this.data.height-1),this},clear:function(){return this.data={children:[],height:1,bbox:i(),leaf:!0},this},remove:function(e){if(!e)return this;for(var t,r,i,s,n=this.data,o=this.toBBox(e),a=[],h=[];n||a.length;){if(n||(n=a.pop(),r=a[a.length-1],t=h.pop(),s=!0),n.leaf&&(i=n.children.indexOf(e),-1!==i))return n.children.splice(i,1),a.push(n),this._condense(a),this;s||n.leaf||!u(n.bbox,o)?r?(t++,n=r.children[t],s=!1):n=null:(a.push(n),h.push(t),t=0,r=n,n=n.children[0])}return this},toBBox:function(e){return e},compareMinX:function(e,t){return e[0]-t[0]},compareMinY:function(e,t){return e[1]-t[1]},toJSON:function(){return this.data},fromJSON:function(e){return this.data=e,this},_all:function(e,t){for(var r=[];e;)e.leaf?t.push.apply(t,e.children):r.push.apply(r,e.children),e=r.pop();return t},_build:function(e,r,i,s){var n,o=i-r+1,a=this._maxEntries;if(a>=o)return n={children:e.slice(r,i+1),height:1,bbox:null,leaf:!0},t(n,this.toBBox),n;s||(s=Math.ceil(Math.log(o)/Math.log(a)),a=Math.ceil(o/Math.pow(a,s-1))),n={children:[],height:s,bbox:null};var h,l,c,u,m=Math.ceil(o/a),p=m*Math.ceil(Math.sqrt(a));for(f(e,r,i,p,this.compareMinX),h=r;i>=h;h+=p)for(c=Math.min(h+p-1,i),f(e,h,c,m,this.compareMinY),l=h;c>=l;l+=m)u=Math.min(l+m-1,c),n.children.push(this._build(e,l,u,s-1));return t(n,this.toBBox),n},_chooseSubtree:function(e,t,r,i){for(var s,n,o,h,c,u,m,f;;){if(i.push(t),t.leaf||i.length-1===r)break;for(m=f=1/0,s=0,n=t.children.length;n>s;s++)o=t.children[s],c=a(o.bbox),u=l(e,o.bbox)-c,f>u?(f=u,m=m>c?c:m,h=o):u===f&&m>c&&(m=c,h=o);t=h}return t},_insert:function(e,t,r){var i=this.toBBox,n=r?e.bbox:i(e),o=[],a=this._chooseSubtree(n,this.data,t,o);for(a.children.push(e),s(a.bbox,n);t>=0&&o[t].children.length>this._maxEntries;)this._split(o,t),t--;this._adjustParentBBoxes(n,o,t)},_split:function(e,r){var i=e[r],s=i.children.length,n=this._minEntries;this._chooseSplitAxis(i,n,s);var o=this._chooseSplitIndex(i,n,s),a={children:i.children.splice(o,i.children.length-o),height:i.height};i.leaf&&(a.leaf=!0),t(i,this.toBBox),t(a,this.toBBox),r?e[r-1].children.push(a):this._splitRoot(i,a)},_splitRoot:function(e,r){this.data={children:[e,r],height:e.height+1},t(this.data,this.toBBox)},_chooseSplitIndex:function(e,t,i){var s,n,o,h,l,u,m,f;for(u=m=1/0,s=t;i-t>=s;s++)n=r(e,0,s,this.toBBox),o=r(e,s,i,this.toBBox),h=c(n,o),l=a(n)+a(o),u>h?(u=h,f=s,m=m>l?l:m):h===u&&m>l&&(m=l,f=s);return f},_chooseSplitAxis:function(e,t,r){var i=e.leaf?this.compareMinX:n,s=e.leaf?this.compareMinY:o,a=this._allDistMargin(e,t,r,i),h=this._allDistMargin(e,t,r,s);h>a&&e.children.sort(i)},_allDistMargin:function(e,t,i,n){e.children.sort(n);var o,a,l=this.toBBox,c=r(e,0,t,l),u=r(e,i-t,i,l),m=h(c)+h(u);for(o=t;i-t>o;o++)a=e.children[o],s(c,e.leaf?l(a):a.bbox),m+=h(c);for(o=i-t-1;o>=t;o--)a=e.children[o],s(u,e.leaf?l(a):a.bbox),m+=h(u);return m},_adjustParentBBoxes:function(e,t,r){for(var i=r;i>=0;i--)s(t[i].bbox,e)},_condense:function(e){for(var r,i=e.length-1;i>=0;i--)0===e[i].children.length?i>0?(r=e[i-1].children,r.splice(r.indexOf(e[i]),1)):this.clear():t(e[i],this.toBBox)},_initFormat:function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return [a"+e.join(", a")+"];")}},e},window.L.Util.rbush=L.RbushSrc(),L.Util.UnblockingFor=function(e,t,r){function i(t){setTimeout(function(){e(t,s)},0)}function s(){n++,t>n?i(n):r()}r=r||function(){};var n=0;i(n)},L.MarkerClassList=function(e){this._classList={},this._marker=e},L.Util.extend(L.MarkerClassList.prototype,{add:function(e){return this._classList[e]=1,this._marker._icon&&L.DomUtil.addClass(this._marker._icon,e),this},remove:function(e){return delete this._classList[e],this._marker._icon&&L.DomUtil.removeClass(this._marker._icon,e),this},contains:function(e){return!!this._classList[e]},clear:function(){if(this._marker._icon)for(var e in this._classList)L.DomUtil.removeClass(this._marker._icon,e);this._classList={}},toString:function(){if(Object.keys)return Object.keys(this._classList).join(" ");var e="";for(var t in this._classList)e+=t+" "},_addClasses:function(){if(this._marker._icon)for(var e in this._classList)L.DomUtil.addClass(this._marker._icon,e)}}),L.markerClassList=function(e){return new L.MarkerClassList(e)},L.MarkerClassCalculation={webWorkerMain:function(){function e(e,r){var s,n,o=[],a={},h=r.seekMarkers.length;if(r.currentLevel=r.levels[e],0==r.currentLevel.size[0]&&0==r.currentLevel.size[1])return void send({type:"markersProcessingFinished",markers:[],zoom:r.currentZoom});for(s=0;h>s;s++){var l=r.seekMarkers[s];if(options.checkMarkerMinimumLevel(l)<=e){var c=t(l,r.currentLevel,r.currentZoom);if(n=i[r.currentZoom].search(c),options.validateGroup(c,n,options)){i[r.currentZoom].insert(c);var u=options.getMarkerId(l);a[u]=a[u]||{},a[u][r.currentZoom]=a[u][r.currentZoom]||r.currentLevel.className}else o.push(l)}else o.push(l)}r.seekMarkers=o.slice(),send({type:"markersChunkReady",zoomClasses:a,priorityLevel:e,zoom:r.currentZoom})}function t(e,t,r){var i=t.safeZone||0,s=t.margin||0,n=Math.max(i,s),o=e._positions[r].x-t.offset[0]-n,a=e._positions[r].y-t.offset[1]-n,h=t.size[0]+2*n,l=t.size[1]+2*n,c=[o,a,o+h,a+l];return c.levelIndex=t.index,c.marker=e,c.safeZone=i,c.margin=s,c.markerX=e._positions[r].x+t.markerOffset[0],c.markerY=e._positions[r].y+t.markerOffset[1],c.markerHeight=t.size[1],c.markerWidth=t.size[0],c}try{var r,i={};registerMsgHandler("calc",function(s){r||(r=options.rbush());var n;send({type:"markersProcessingStarted"}),i[s.currentZoom]||(i[s.currentZoom]=r());var o={seekMarkers:[],currentZoom:s.currentZoom,markers:s.markers,levels:s.levels,currentLevel:s.levels[0]};for(n=0;n<o.markers.length;n++)o.markers[n].showAlways&&i[s.currentZoom].insert(t(o.markers[n],o.currentLevel,o.currentZoom)),o.markers[n]._generalizationImmune||o.markers[n].showAlways||o.seekMarkers.push(o.markers[n]);for(n=0;n<o.levels.length;n++)e(n,o);send({type:"markersProcessingFinished",zoom:o.currentZoom})})}catch(s){self.console.error(s)}},createCalculationWorker:function(e){return e.rbush=L.RbushSrc,L.WebWorkerHelper.createWorker(this.webWorkerMain,e)}},L.WebWorkerHelper={workerInit:function(){msgHandlers={},options={},registerMsgHandler=function(e,t){msgHandlers[e]||(msgHandlers[e]=t)},dropMsgHandler=function(e){delete msgHandlers[e]},send=function(e){postMessage(JSON.stringify(e))},self.onmessage=function(e){switch(e.data.type){case"init":for(var t in e.data.options){var r=e.data.options[t];r&&r.substr&&"blob"==r.substr(0,4)?importScripts(r):options[t]=r}break;default:var i=JSON.parse(e.data.buf);i.type=e.data.type,msgHandlers[e.data.type]&&msgHandlers[e.data.type](i)}}},getMainFunc:function(e){return URL.createObjectURL(new Blob(["(",this.workerInit.toString(),")();","(",e.toString(),")();"],{type:"application/javascript"}))},getFunctionalParameter:function(e,t){return URL.createObjectURL(new Blob(['options["'+t,'"] = ',e.toString()],{type:"application/javascript"}))},createWorker:function(e,t){var r=new Worker(this.getMainFunc(e));for(var i in t)"function"==typeof t[i]&&(t[i]=this.getFunctionalParameter(t[i],i));return r.postMessage({type:"init",options:t}),r._messageListeners={},r.onmessage=function(e){var t=JSON.parse(e.data);r._messageListeners[t.type]&&r._messageListeners[t.type](t),r._semaphoresDelta[t.type]&&(r._nowProcessing+=r._semaphoresDelta[t.type],requestAnimationFrame(r._processQueue))},r._queue=[],r._packetChunkSize=2,r._nowProcessing=0,r._semaphoresDelta={},r.registerExpectedReturns=function(e,t){r._semaphoresDelta[e]=1,r._semaphoresDelta[t]=-1},r.registerMsgHandler=function(e,t){r._messageListeners[e]||(r._messageListeners[e]=t)},r.dropMsgHandler=function(e){delete r._messageListeners[e]},r.send=function(e,t){r._queue.push({name:e,content:t}),requestAnimationFrame(r._processQueue)},r._processQueue=function(){if(!(r._nowProcessing>r._packetChunkSize)){var e=r._queue.shift();if(e){r._semaphoresDelta[e.name]&&(r._nowProcessing+=r._semaphoresDelta[e.name]);var t=JSON.stringify(e.content);r.postMessage({type:e.name,buf:t})}}},r}},L.MarkerEx=L.Marker.extend({_extended:!0,_generalizationImmune:!1,onAdd:function(e){L.Marker.prototype.onAdd.apply(this,arguments),this._immunityLevel==this.IMMUNITY.NO_DELETE&&(this._icon.style.display="block"),this.classes._addClasses()},getEvents:function(){return this._zoomAnimated=!1,L.Marker.prototype.getEvents.apply(this,arguments)},onBeforeRemove:function(){return this._immunityLevel==this.IMMUNITY.NO_HIDE?!1:this._immunityLevel==this.IMMUNITY.NO_DELETE?(this._icon.style.display="none",!1):!0},initialize:function(){L.Marker.prototype.initialize.apply(this,arguments),this.classes=L.markerClassList(this)},IMMUNITY:{NONE:0,NO_DELETE:1,NO_HIDE:2},_immunityLevel:null,immunifyForDeletion:function(){return this._immunityLevel=this.IMMUNITY.NO_DELETE,this},immunifyForHide:function(){return this._immunityLevel=this.IMMUNITY.NO_HIDE,this},revokeImmunity:function(){return this._immunityLevel=this.IMMUNITY.NONE,this},generalizationImmunity:function(){this._generalizationImmune=!0}}),L.markerEx=function(e,t){return new L.MarkerEx(e,t)},L.MarkerGeneralizeGroupDefaults={chunkSize:20,levels:[{margin:30,safeZone:20,size:[25,40],offset:[12.5,40],className:"_pin"},{safeZone:5,size:[6,6],className:"_bullet"},{safeZone:0,className:"_hidden"}],viewportHideOffset:1,checkMarkersIntersection:function(e,t){var r=Math.max(e.safeZone,t.margin);return Math.abs(e.markerX-t.markerX)>r+e.markerWidth/2+t.markerWidth/2||Math.abs(e.markerY-t.markerY)>r+e.markerHeight/2+t.markerHeight/2},checkMarkerMinimumLevel:function(){return 0},pane:"markerPane",getMarkerFields:function(){return[]},getMarkerId:function(e){return e.id}},L.MarkerGeneralizeGroup=L.FeatureGroup.extend({options:L.MarkerGeneralizeGroupDefaults,initialize:function(e){L.Util.setOptions(this,e),this._layersCount=0,this._layers={},this._layersById={},this._zoomReady={},this._priorityMarkers=[],this._otherMarkers=[],this._setMaxZoom(e.maxZoom),this._setMinZoom(e.minZoom),this.on("invalidationFinish",function(){this.getPane().style.display="block"})},addLayers:function(e){for(var t=0;t<e.length;t++)this._addLayer(e[t]),this._prepareMarker(e[t]);this._map&&this._calculateMarkersClassForEachZoom(e)},addLayer:function(e){if(this._addLayer(e),this._map){this._prepareMarker(e);var t=this;this._calculateMarkersClassForEachZoom([e],function(){t._invalidateMarkers()})}return this},removeLayer:function(e){return this._removeLayer(e)&&(this._calculateMarkersClassForEachZoom(),this._invalidateMarkers()),this},onAdd:function(e){this._map=e,this.getLayers().length&&(this.eachLayer(this._prepareMarker,this),requestAnimationFrame(this._calculateMarkersClassForEachZoom.bind(this)))},onRemove:function(e){this._map&&(L.LayerGroup.prototype.onRemove.call(this,e),this.eachLayer(function(e){e.options.state="HIDDEN"}),this._map=null)},clearLayers:function(){var e;for(e in this._layers)this._removeLayer(this._layers[e]);return this._priorityMarkers=[],this._otherMarkers=[],this},getEvents:function(){var e={zoomstart:this._zoomStart,zoomend:this._zoomEnd,moveend:this._invalidateMarkers};return e},_setMaxZoom:function(e){!isNaN(e)&&19>=e&&(this._maxZoom=e)},_setMinZoom:function(e){if(!isNaN(e)&&e>=0){if(e>this._getMaxZoom())throw new Error("Min zoom must be smaller than max zoom");this._minZoom=e}},_getMaxZoom:function(){return isNaN(this._maxZoom)?this._map.getMaxZoom():this._maxZoom},_getMinZoom:function(){return isNaN(this._minZoom)?this._map.getMinZoom():this._minZoom},_getLevels:function(e){var t,r=this.options;return t="function"==typeof r.levels?r.levels(this._map,e):r.levels,this._prepareLevels(t)},_prepareLevels:function(e){var t,r,i;for(t=0;t<e.length;t++)for(i=e[t],i.index=t,i.markerOffset=[],i.markerDistance=[],i.size||(i.size=[0,0]),i.offset||(i.offset=[i.size[0]/2,i.size[1]/2]),r=0;2>r;r++)i.markerOffset[r]=i.size[r]/2-i.offset[r];return e},_prepareMarker:function(e){if(!e._prepared){for(var t=this._getMaxZoom(),r=this._getMinZoom();t>=r;t--)this._setMarkerPosition(e,t);e._prepared=!0}},_setMarkerPosition:function(e,t){e._positions[t]=this._map.project(e.getLatLng(),t),e.options.classForZoom=e.options.classForZoom||[],e.options.classForZoom[t]=e.options.classForZoom[t]||"HIDDEN"},_calculateMarkersClassForEachZoom:function(e){for(var t=this,r=this._map.getZoom(),i=this._getMaxZoom(),s=[],n=this._getMinZoom();i>=n;n++)s.push(n);s.sort(function(e,t){return Math.abs(r-e)-Math.abs(r-t)}),this._calculateMarkersClassForZoom(e,r,function(){L.Util.UnblockingFor(function(r,i){var n=s[r];t._calculateMarkersClassForZoom(e,n,i)},s.length,function(){t._calculationBusy=!1,t.fireEvent("calculationFinish"),t._calculationQueued&&(t._calculationQueued=!1,t._calculateMarkersClassForEachZoom())})})},_calculateMarkersClassForZoom:function(e,t,r){function i(e,r){var i=[],s=p.length;if(a=c[e],0==c[e].size[0]&&0==c[e].size[1])return void r();for(var o=0;s>o;o++){var h=p[o];if(u.options.checkMarkerMinimumLevel(h)<=e){var _=n(h,a);f=m.search(_),u._validateGroup(_,f,u.options)?(m.insert(_),h.options.classForZoom[t]=a.className,l[e].push(h)):i.push(h)}else i.push(h)}p=i.slice(),r()}function s(){u._zoomReady[t]=!0,u._map.getZoom()==t&&u._invalidateMarkers(),r()}function n(e,r){var i=r.safeZone||0,s=r.margin||0,n=Math.max(i,s);e._positions[t]||u._setMarkerPosition(e,t);var o=e._positions[t].x-r.offset[0]-n,a=e._positions[t].y-r.offset[1]-n,h=r.size[0]+2*n,l=r.size[1]+2*n,c=[o,a,o+h,a+l];return c.levelIndex=r.index,c.marker=e,c.safeZone=i,c.margin=s,c.markerX=e._positions[t].x+r.markerOffset[0],c.markerY=e._positions[t].y+r.markerOffset[1],c.markerHeight=r.size[1],c.markerWidth=r.size[0],c}var o,a,h,l={},c=this._getLevels(t),u=this;for(o=0;o<c.length;o++)l[o]=[];var m=L.Util.rbush();for(a=c[0],o=0;o<this._priorityMarkers.length;o++)h=this._prepareMarker(this._priorityMarkers[o]),l[a].push(h),m.insert(n(h,a));var f,p=[];for(o=0;o<this._otherMarkers.length;o++)h=this._otherMarkers[o],p.push(h);L.Util.UnblockingFor(i,c.length,s)},_getPixelBoundsForZoom:function(e){var t,r=Number.MAX_VALUE,i=Number.MAX_VALUE,s=0,n=0;return this.eachLayer(function(o){o._positions[e]||that._setMarkerPosition(o,e),t=o._positions[e],r=Math.min(r,t.x),i=Math.min(i,t.y),s=Math.max(s,t.x),n=Math.max(n,t.y)}),{x:r,y:i,width:s-r,height:n-i}},_validateGroup:function(e,t,r){if(0==t.length)return!0;var i;for(i=0;i<t.length;i++)if(!r.checkMarkersIntersection(e,t[i]))return!1;return!0},_invalidateMarkers:function(){var e=this._map.getZoom();if(this._zoomReady[e]){var t=this._map.getPixelBounds(),r=(t.max.x-t.min.x)*this.options.viewportHideOffset,i=(t.max.y-t.min.y)*this.options.viewportHideOffset;t.min._subtract({x:r,y:i}),t.max._add({x:r,y:i}),this.eachLayer(function(r){var i=r.options.classForZoom[e],s=r._positions[e],n=r.options.state;r._immunityLevel&&(r._map||this._map.addLayer(r),n!=i&&"HIDDEN"!=i&&L.DomUtil.addClass(r._icon,i)),t.contains(s)?"HIDDEN"!=i&&n!=i&&(r._map||this._map.addLayer(r),n!=i&&(n&&"HIDDEN"!=n&&L.DomUtil.removeClass(r._icon,n),L.DomUtil.addClass(r._icon,i))):i="HIDDEN","HIDDEN"==i&&(!r.onBeforeRemove||r.onBeforeRemove&&r.onBeforeRemove())&&this._map.removeLayer(r),r.options.state=i},this),this.fireEvent("invalidationFinish")}},_applyClasses:function(e,t,r){if(e){var i=this.options.getMarkerId(e);t[i]&&t[i][r]&&e.options.classForZoom[r]&&(e.options.classForZoom[r]=t[i][r])}},_invalidateSingleMarker:function(e,t,r){if(e){var i=e.options.classForZoom[r],s=e._positions[r],n=e.options.state,o=e.onBeforeRemove||function(){return!0};if(e.options.state=i,e._immunityLevel)return e._map||this._map.addLayer(e),void(n!=i&&"HIDDEN"!=i&&L.DomUtil.addClass(e._icon,i));t.contains(s)||(i="HIDDEN",o.apply(e)&&this._map.removeLayer(e)),n!=i&&"HIDDEN"!=i&&(e._map||this._map.addLayer(e),i&&(n&&"HIDDEN"!=n&&L.DomUtil.removeClass(e._icon,n),L.DomUtil.addClass(e._icon,i)))}},_zoomStart:function(){this.getPane().style.display="none"},_zoomEnd:function(){this.getPane().style.display="block"},_addLayer:function(e){e._positions={},e.showAlways?this._priorityMarkers.push(e):this._otherMarkers.push(e);var t=this._map;t&&(this._map=null),this._layersCount++,this._layersById[this.options.getMarkerId(e)]=e,L.LayerGroup.prototype.addLayer.call(this,e),t&&(this._map=t)},_removeLayer:function(e){var t=this._layers.length;return this._layersCount--,delete this._layersById[this.options.getMarkerId(e)],L.LayerGroup.prototype.removeLayer.call(this,e),t-this._layers.length!=0}}),L.MarkerStreamingGeneralizeGroup=L.MarkerGeneralizeGroup.extend({initialize:function(e){L.MarkerGeneralizeGroup.prototype.initialize.call(this,e),this._workerOptions={checkMarkersIntersection:e.checkMarkersIntersection,checkMarkerMinimumLevel:e.checkMarkerMinimumLevel,getMarkerFields:e.getMarkerFields,getMarkerId:e.getMarkerId,validateGroup:this._validateGroup},this._worker=L.MarkerClassCalculation.createCalculationWorker(this._workerOptions)},addLayers:function(e){return L.MarkerGeneralizeGroup.prototype.addLayers.call(this,e),this},_calculateMarkersClassForEachZoom:function(e,t){for(var r=this,i=this._map.getZoom(),s=this._getMaxZoom(),n=[],o=this._getMinZoom();s>=o;o++)n.push(o);n.sort(function(e,t){return Math.abs(i-e)-Math.abs(i-t)});for(var a=0,h=0;h<n.length;h++)a++,r._calculateMarkersClassForZoom(e,n[h],function(e){a--,0===a&&(t&&t(),r.fireEvent("calculationFinish"))})},_calculateMarkersClassForZoom:function(e,t,r){var i=this._getLevels(t),s=this,n="markersChunkReady",o="calc",a={levels:i,markers:this._flattenMarkers(e),currentZoom:t};this._worker.registerExpectedReturns(o,n),this._worker.registerMsgHandler(n,function(e){if(s._map.getZoom()==e.zoom)s._invalidateMarkers(null,e.zoomClasses);else for(var t in e.zoomClasses)s._applyClasses(s._layersById[t],e.zoomClasses,e.zoom)}),this._worker.registerMsgHandler("markersProcessingFinished",function(e){e.zoom==s._map.getZoom()&&s.fireEvent("markersProcessingFinish"),r(e.zoom)}),requestAnimationFrame(function(){s._worker.send(o,a)})},_flattenMarkers:function(e){if(!e)return[];this._tt=this._tt||0;var t=(new Date).getTime();for(var r in e)this._prepareMarker(e[r]);for(var i=["_positions","showAlways"].concat(this.options.getMarkerFields()),s=[],n=0;n<e.length;n++){s[n]={};for(var o=0;o<i.length;o++)s[n][i[o]]=e[n][i[o]]}return this._tt+=(new Date).getTime()-t,s},_invalidateMarkers:function(e,t){var r=this._map.getZoom(),i=this._map.getPixelBounds(),s=(i.max.x-i.min.x)*this.options.viewportHideOffset,n=(i.max.y-i.min.y)*this.options.viewportHideOffset;if(i.min._subtract({x:s,y:n}),i.max._add({x:s,y:n}),t)for(var o in t)this._applyClasses(this._layersById[o],t,r),this._invalidateSingleMarker(this._layersById[o],i,r);else this.eachLayer(function(e){this._invalidateSingleMarker(e,i,r)},this);console.log("Inv finished"),this.fireEvent("invalidationFinish")}});