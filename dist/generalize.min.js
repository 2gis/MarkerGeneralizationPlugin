!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.MarkerGeneralizationPlugin=t():e.MarkerGeneralizationPlugin=t()}("undefined"!=typeof self?self:this,function(){return function(e){function t(i){if(r[i])return r[i].exports;var n=r[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,i){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="/dist/",t(t.s=0)}([function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(){L.markerEx=function(e,t){return new a.default(e,t)},L.markerGeneralizeGroup=function(e){return new u.default(e)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=n;var o=r(1),a=i(o),s=r(3),u=i(s)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(2);!function(e){e&&e.__esModule}(i),t.default=L.Marker.extend({_extended:!0,onAdd:function(){L.Marker.prototype.onAdd.apply(this,arguments),this._immunityLevel==this.IMMUNITY.NO_DELETE&&(this._icon.style.display="block"),this.classes._addClasses()},getEvents:function(){return this._zoomAnimated=!1,L.Marker.prototype.getEvents.apply(this,arguments)},onBeforeRemove:function(){return this._immunityLevel!=this.IMMUNITY.NO_HIDE&&(this._immunityLevel!=this.IMMUNITY.NO_DELETE||(this._icon.style.display="none",!1))},initialize:function(){L.Marker.prototype.initialize.apply(this,arguments),this.classes=L.markerClassList(this)},IMMUNITY:{NONE:0,NO_DELETE:1,NO_HIDE:2},_immunityLevel:null,immunifyForDeletion:function(){return this._immunityLevel=this.IMMUNITY.NO_DELETE,this},immunifyForHide:function(){return this._immunityLevel=this.IMMUNITY.NO_HIDE,this},revokeImmunity:function(){return this._immunityLevel=this.IMMUNITY.NONE,this}})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),L.MarkerClassList=function(e){this._classList={},this._marker=e},L.Util.extend(L.MarkerClassList.prototype,{add:function(e){return this._classList[e]=1,this._marker._icon&&L.DomUtil.addClass(this._marker._icon,e),this},remove:function(e){return delete this._classList[e],this._marker._icon&&L.DomUtil.removeClass(this._marker._icon,e),this},contains:function(e){return!!this._classList[e]},clear:function(){if(this._marker._icon)for(var e in this._classList)L.DomUtil.removeClass(this._marker._icon,e);this._classList={}},toString:function(){if(Object.keys)return Object.keys(this._classList).join(" ");var e="";for(var t in this._classList)e+=t+" ";return e},_addClasses:function(){if(this._marker._icon)for(var e in this._classList)L.DomUtil.addClass(this._marker._icon,e)}}),L.markerClassList=function(e){return new L.MarkerClassList(e)},t.default=L.MarkerClassList},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(4);t.default=L.FeatureGroup.extend({options:{levels:[{margin:30,safeZone:20,size:[25,40],offset:[.5,1],className:"_pin"},{safeZone:5,size:[6,6],className:"_bullet"},{safeZone:0,className:"_hidden"}],bufferPart:.5,checkMarkerMinimumLevel:function(){return 0},pane:"markerPane"},initialize:function(e){L.Util.setOptions(this,e),this._generalizer=new i.General,this._layers={},this._priorityMarkers=[],this._otherMarkers=[],this.setMaxZoom(e.maxZoom),this.setMinZoom(e.minZoom),this._initZooms(),this.on("invalidationFinish",function(){this.getPane().style.display="block"})},setMaxZoom:function(e){!isNaN(e)&&e<=19&&(this._maxZoom=e)},setMinZoom:function(e){if(!isNaN(e)&&e>=0){if(e>this._getMaxZoom())throw new Error("Min zoom must be smaller than max zoom");this._minZoom=e}},_getMaxZoom:function(){return isNaN(this._maxZoom)?this._map?this._map.getMaxZoom():18:this._maxZoom},_getMinZoom:function(){return isNaN(this._minZoom)?this._map?this._map.getMinZoom():0:this._minZoom},_initZooms:function(){this._zoomStat={};for(var e=this._getMaxZoom(),t=this._getMinZoom();t<=e;++t)this._zoomStat[t]={ready:!1,pending:!1,markers:null,bounds:{minX:0,minY:0,maxX:0,maxY:0}}},_getLevels:function(e){var t,r=this.options;return t="function"==typeof r.levels?r.levels(this._map,e):r.levels,this._prepareLevels(t)},_prepareLevels:function(e){for(var t=void 0,r=0;r<e.length;r++)t=e[r],t.index=r,t.size||(t.size=[0,0]),t.offset||(t.offset=[.5,.5]),t.margin||(t.margin=0),t.safeZone||(t.safeZone=0),t.degradation||(t.degradation=0);return e},_addLayer:function(e){e.addEventParent(this),e.showAlways?this._priorityMarkers.push(e):this._otherMarkers.push(e);var t=this._map;t&&(this._map=null),L.LayerGroup.prototype.addLayer.call(this,e),t&&(this._map=t)},_getScreenBounds:function(){if(!this._map)return{minX:0,minY:0,maxX:0,maxY:0};var e=this._map.getSize();return{minX:0,minY:0,maxX:e.x*window.devicePixelRatio,maxY:e.y*window.devicePixelRatio}},_getBounds:function(){var e=this._getScreenBounds();return{minX:e.minX-(e.maxX-e.minX)*this.options.bufferPart,minY:e.minY-(e.maxY-e.minY)*this.options.bufferPart,maxX:e.maxX+(e.maxX-e.minX)*this.options.bufferPart,maxY:e.maxY+(e.maxY-e.minY)*this.options.bufferPart}},_getLatLngBounds:function(e,t,r){var i=this._map._getTopLeftPoint(t,r),n=new L.Bounds(i.add(L.point(e.minX,e.minY)),i.add(L.point(e.maxX,e.maxY))),o=this._map.unproject(n.getBottomLeft(),r),a=this._map.unproject(n.getTopRight(),r);return new L.LatLngBounds(o,a)},_prepareMarker:function(e){for(var t=this._getMinZoom(),r=this._getMaxZoom();r>=t;--r)e.options.classForZoom=e.options.classForZoom||[],e.options.classForZoom[r]="HIDDEN"},_prepareMarkersForGeneralization:function(e,t){var r=this._map._getTopLeftPoint(t,e);if(this._zoomStat[e].markers){for(var i=0;i<this._zoomStat[e].markers.length;++i){var n=this._map.project(this._zoomStat[e].markers[i]._latlng,e).subtract(r);this._zoomStat[e].markers[i].pixelPosition=[n.x,n.y]}return this._zoomStat[e].markers}for(var o=new Array(this._otherMarkers.length),a=0;a<this._otherMarkers.length;++a){var s=this._map.project(this._otherMarkers[a]._latlng,e).subtract(r),u={_latlng:this._otherMarkers[a]._latlng,groupIndex:this.options.checkMarkerMinimumLevel(this._otherMarkers[a]),iconIndex:-1,pixelPosition:[s.x,s.y]};o[a]=u}return o},_calculateMarkersClassesIfNeeded:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._map.getZoom();if(this._map){if(!this._zoomStat[e].ready&&!this._zoomStat[e].pending)return void this._calculateMarkersClasses(e);var t=this._zoomStat[e].bounds,r=this._getScreenBounds(),i=this._getLatLngBounds(r,this._map.getCenter(),e);if(!t.contains(i))return void this._calculateMarkersClasses(e);this._invalidateMarkers()}},_calculateMarkersClasses:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._map.getZoom();if(this._map){var r=this._getLevels(t),i=this._map.getCenter(),n=window.devicePixelRatio,o=this._getBounds(),a=r.map(function(e){return{iconIndex:e.index,safeZone:e.safeZone,margin:e.margin,degradation:e.degradation||0}}),s=r.map(function(e){return{size:e.size,anchor:e.offset,pixelDensity:n>1?2:1}}),u=this._prepareMarkersForGeneralization(t,i);return this._zoomStat[t].ready=!1,this._zoomStat[t].pending=!0,this._zoomStat[t].bounds=this._getLatLngBounds(o,i,t),this._zoomStat[t].markers=u,this._generalizer.generalize(o,n,a,s,u).then(function(){for(var i=0;i<e._otherMarkers.length;++i){var n=e._otherMarkers[i],o=u[i].iconIndex;n.options.classForZoom[t]=-1==o?"HIDDEN":r[o].className}for(var a=0;a<e._priorityMarkers.length;++a){var s=e._priorityMarkers[a],l=e.options.checkMarkerMinimumLevel(s);s.options.classForZoom[t]=-1==l?"HIDDEN":r[l].className}e._zoomStat[t].ready=!0,e._zoomStat[t].pending=!1,e._map.getZoom()==t&&e._invalidateMarkers()}).catch(function(){e.fireEvent("generalizationError")})}},_invalidateMarkers:function(){var e=this._map.getZoom();if(this._zoomStat[e].ready){for(var t in this._layers){var r=this._layers[t],i=r.options.classForZoom[e],n=r.options.state;r._immunityLevel&&(r._map||this._map.addLayer(r),n!=i&&"HIDDEN"!=i&&L.DomUtil.addClass(r._icon,i)),"HIDDEN"!=i&&n!=i&&(r._map||this._map.addLayer(r),n!=i&&(n&&"HIDDEN"!=n&&L.DomUtil.removeClass(r._icon,n),L.DomUtil.addClass(r._icon,i))),"HIDDEN"==i&&(!r.onBeforeRemove||r.onBeforeRemove&&r.onBeforeRemove())&&this._map.removeLayer(r),r.options.state=i}this.fireEvent("invalidationFinish")}},_zoomStart:function(){this._zoomStat[this._map.getZoom()].markers=null,this.getPane().style.display="none"},addLayer:function(e){return this._addLayer(e),this._map&&!e._immunityLevel&&(this._zoomStat[this._map.getZoom()].markers=null,this._prepareMarker(e),this._calculateMarkersClasses(),this._invalidateMarkers()),this},addLayers:function(e){var t;for(t=0;t<e.length;t++)this._addLayer(e[t]);return this._map&&(this._zoomStat[this._map.getZoom()].markers=null,this.eachLayer(this._prepareMarker,this),setTimeout(this._calculateMarkersClasses.bind(this),0)),this},_removeLayer:function(e){var t,r=this._layers.length;return-1!=(t=this._priorityMarkers.indexOf(e))?this._priorityMarkers.splice(t,1):-1!=(t=this._otherMarkers.indexOf(e))&&this._otherMarkers.splice(t,1),L.LayerGroup.prototype.removeLayer.call(this,e),r-this._layers.length!=0},removeLayer:function(e){return this._removeLayer(e)&&(this._calculateMarkersClasses(),this._invalidateMarkers()),this},getEvents:function(){var e=this;return{zoomstart:this._zoomStart,zoomend:function(){return e._calculateMarkersClassesIfNeeded()},moveend:function(){return e._calculateMarkersClassesIfNeeded()}}},onAdd:function(e){this._map=e,this._initZooms(),this.getLayers().length&&(this.eachLayer(this._prepareMarker,this),setTimeout(this._calculateMarkersClasses.bind(this),0))},onRemove:function(e){if(this._map){L.LayerGroup.prototype.onRemove.call(this,e);for(var t in this._layers)this._layers[t].options.state="HIDDEN";this._map=null}},clearLayers:function(){var e;for(e in this._layers)this._removeLayer(this._layers[e]);return this._priorityMarkers=[],this._otherMarkers=[],this}})},function(e,t,r){"use strict";(function(e){var r,i,n,o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(a,s){"object"==o(t)&&"object"==o(e)?e.exports=s():(i=[],r=s,void 0!==(n="function"==typeof r?r.apply(t,i):r)&&(e.exports=n))}(0,function(){return function(e){function t(i){if(r[i])return r[i].exports;var n=r[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,i){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="/dist/",t(t.s=1)}([function(e,t,r){r.d(t,"a",function(){return i}),r.d(t,"b",function(){return n});var i={pixelPositionX:0,pixelPositionY:1,groupIndex:2,iconIndex:3,prevGroupIndex:4},n=Object.keys(i).length},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var i=r(2);r.d(t,"General",function(){return i.a})},function(e,t,r){r.d(t,"a",function(){return a});var i=r(0),n=r(3),o=r.n(n),a=function(){function e(){var e=this;this.worker=o()(4),this.queue=[],this.currentJob=void 0,this.markerArray=new Float32Array(1e3*i.b),this.worker.onmessage=function(t){if(void 0!==e.currentJob){var r=e.currentJob,i=r.markers,n=r.resolve;e.recordResult(i,t.data),e.markerArray=t.data,e.currentJob=void 0,e.dequeue(),n()}}}return e.prototype.generalize=function(e,t,r,i,n){var o=this,a={bounds:e,pixelRatio:t,priorityGroups:r,sprites:i};return new Promise(function(e){o.queue.push({message:a,markers:n,resolve:e}),o.dequeue()})},e.prototype.clear=function(){this.queue=[]},e.prototype.pack=function(e){e.length*i.b>this.markerArray.length&&(this.markerArray=new Float32Array(e.length*i.b));for(var t=this.markerArray,r=0,n=0;r<e.length;r++,n+=i.b){var o=e[r],a=o.iconIndex,s=o.prevGroupIndex;this.markerArray[n+i.a.pixelPositionX]=o.pixelPosition[0],this.markerArray[n+i.a.pixelPositionY]=o.pixelPosition[1],t[n+i.a.groupIndex]=o.groupIndex,t[n+i.a.iconIndex]=void 0!==a?a:NaN,t[n+i.a.prevGroupIndex]=void 0!==s?s:NaN}},e.prototype.dequeue=function(){if(void 0===this.currentJob){var e=this.queue.shift();if(void 0!==e){this.pack(e.markers);var t=e.message;t.markers=this.markerArray,t.markerCount=e.markers.length,this.worker.postMessage(t,[t.markers.buffer]),this.currentJob=e}}},e.prototype.recordResult=function(e,t){for(var r=0,n=0;r<e.length;r++,n+=i.b){var o=t[n+i.a.iconIndex],a=t[n+i.a.prevGroupIndex];e[r].iconIndex=o!==o?void 0:o,e[r].prevGroupIndex=a!==a?void 0:a}},e}()},function(e,t,r){function i(e){function t(i){if(r[i])return r[i].exports;var n=r[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var r={};t.m=e,t.c=r,t.i=function(e){return e},t.d=function(e,r,i){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="/",t.oe=function(e){throw console.error(e),e};var i=t(t.s=ENTRY_MODULE);return i.default||i}function n(e){return(e+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function o(e){var t=[],r=e.toString(),i=r.match(/^function\s?\(\w+,\s*\w+,\s*(\w+)\)/);if(!i)return t;for(var o,a=i[1],s=new RegExp("(\\\\n|\\W)"+n(a)+"\\((/\\*.*?\\*/)?s?.*?([\\.|\\-|\\w|/|@]+).*?\\)","g");o=s.exec(r);)t.push(o[3]);return t}function a(e,t){for(var r=[t],i=[],n={};r.length;){var a=r.pop();if(!n[a]&&e[a]){n[a]=!0,i.push(a);var s=o(e[a]);r=r.concat(s)}}return i}e.exports=function(e,t){t=t||{};var n=r.m,o=t.all?Object.keys(n):a(n,e),s="("+i.toString().replace("ENTRY_MODULE",JSON.stringify(e))+")({"+o.map(function(e){return JSON.stringify(e)+": "+n[e].toString()}).join(",")+"})(self);",u=new window.Blob([s],{type:"text/javascript"});if(t.bare)return u;var l=window.URL||window.webkitURL||window.mozURL||window.msURL,m=l.createObjectURL(u),c=new window.Worker(m);return c.objectURL=m,c}},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var i=r(5);t.default=function(e){e.onmessage=function(t){var r=t.data;Object(i.a)(r),e.postMessage(r.markers)}}},function(e,t,r){function i(e){for(var t=e.bounds,r=e.pixelRatio,i=e.priorityGroups,h=e.sprites,p=e.markers,d=e.markerCount,_=1+(t.maxX-t.minX>>3)<<3,v=t.maxY-t.minY,y=_*v+8>>3,x=new Uint8Array(y),g=new Uint8Array(y),k=new Uint8Array(y),L=0;L<d;L++){var M=p[L*l.b+l.a.prevGroupIndex],b=p[L*l.b+l.a.pixelPositionX],I=p[L*l.b+l.a.pixelPositionY];if(!a(M)){var w=i[M],z=w.iconIndex,N=w.margin,P=w.degradation,Y=h[z];if(!Y)continue;var Z=Y.size,E=Y.anchor,O=Y.pixelDensity;u(c,_,v,r,Z,E,O,b,I,N),s(c)||o(x,_,c),u(f,_,v,r,Z,E,O,b,I,P),s(f)||o(k,_,f)}}for(var L=0;L<i.length;L++){var S=i[L],D=S.safeZone,z=S.iconIndex,N=S.margin,P=S.degradation,Y=h[z];if(Y){var Z=Y.size,E=Y.anchor,O=Y.pixelDensity;g.set(k);for(var X=0;X<d;X++){var j=X*l.b,C=p[j+l.a.groupIndex],M=p[j+l.a.prevGroupIndex],b=p[j+l.a.pixelPositionX],I=p[j+l.a.pixelPositionY];C>L||!a(M)||(u(c,_,v,r,Z,E,O,b,I,N),s(c)||C===L&&n(g,_,c)||(u(m,_,v,r,Z,E,O,b,I,D),s(m)||n(x,_,m)||(u(f,_,v,r,Z,E,O,b,I,P),o(x,_,c),o(k,_,f),p[j+l.a.iconIndex]=z,p[j+l.a.prevGroupIndex]=L)))}}}}function n(e,t,r){for(var i=r.minX,n=r.minY,o=r.maxX,a=r.maxY,s=n;s<a;s++){var u=s*t+i>>3,l=s*t+o>>3,m=0;if(u===l)m=e[u]&255>>(7&i)&255<<8-(7&o);else{m=e[u]&255>>(7&i);for(var c=u+1;c<l;c++)m=e[c]|m;m=e[l]&255<<8-(7&o)|m}if(0!==m)return!0}return!1}function o(e,t,r){for(var i=r.minX,n=r.minY,o=r.maxX,a=r.maxY,s=n;s<a;s++){var u=s*t+i>>3,l=s*t+o>>3;if(u===l)e[u]=e[u]|255>>(7&i)&255<<8-(7&o);else{e[u]=e[u]|255>>(7&i);for(var m=u+1;m<l;m++)e[m]=255;e[l]=e[l]|255<<8-(7&o)}}}function a(e){return e!==e}function s(e){return e.minX===e.maxX||e.minY===e.maxY}function u(e,t,r,i,n,o,a,s,u,l){var m=i/a,c=s*i-n[0]*m*o[0]-l|0,f=u*i-n[1]*m*o[1]-l|0,h=s*i+n[0]*m*(1-o[0])+l|0,p=u*i+n[1]*m*(1-o[1])+l|0;e.minX=c>0?c<t?c:t:0,e.minY=f>0?f<r?f:r:0,e.maxX=h>0?h<t?h:t:0,e.maxY=p>0?p<r?p:r:0}t.a=i;var l=r(0),m={minX:0,minY:0,maxX:0,maxY:0},c={minX:0,minY:0,maxX:0,maxY:0},f={minX:0,minY:0,maxX:0,maxY:0}}])})}).call(t,r(5)(e))},function(e,t,r){"use strict";e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}}])});
//# sourceMappingURL=generalize.min.js.map