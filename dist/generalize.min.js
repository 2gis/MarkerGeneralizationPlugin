!function(e,t){function s(e,t,s,i){this.max_objects=t||10,this.max_levels=s||4,this.level=i||0,this.bounds=e,this.objects=[],this.nodes=[]}s.prototype.split=function(){var e=this.level+1,i=t.round(this.bounds.width/2),o=t.round(this.bounds.height/2),r=t.round(this.bounds.x),a=t.round(this.bounds.y);this.nodes[0]=new s({x:r+i,y:a,width:i,height:o},this.max_objects,this.max_levels,e),this.nodes[1]=new s({x:r,y:a,width:i,height:o},this.max_objects,this.max_levels,e),this.nodes[2]=new s({x:r,y:a+o,width:i,height:o},this.max_objects,this.max_levels,e),this.nodes[3]=new s({x:r+i,y:a+o,width:i,height:o},this.max_objects,this.max_levels,e)},s.prototype.getIndex=function(e){var t=-1,s=this.bounds.x+this.bounds.width/2,i=this.bounds.y+this.bounds.height/2,o=e.y<i&&e.y+e.height<i,r=e.y>i;return e.x<s&&e.x+e.width<s?o?t=1:r&&(t=2):e.x>s&&(o?t=0:r&&(t=3)),t},s.prototype.insert=function(e){var t,s=0;if("undefined"!=typeof this.nodes[0]&&(t=this.getIndex(e),-1!==t))return void this.nodes[t].insert(e);if(this.objects.push(e),this.objects.length>this.max_objects&&this.level<this.max_levels)for("undefined"==typeof this.nodes[0]&&this.split();s<this.objects.length;)t=this.getIndex(this.objects[s]),-1!==t?this.nodes[t].insert(this.objects.splice(s,1)[0]):s+=1},s.prototype.retrieve=function(e){var t=this.getIndex(e),s=this.objects;if("undefined"!=typeof this.nodes[0])if(-1!==t)s=s.concat(this.nodes[t].retrieve(e));else for(var i=0;i<this.nodes.length;i+=1)s=s.concat(this.nodes[i].retrieve(e));return s},s.prototype.clear=function(){this.objects=[];for(var e=0;e<this.nodes.length;e+=1)"undefined"!=typeof this.nodes[e]&&(this.nodes[e].clear(),delete this.nodes[e])},e.L.Util.Quadtree=s}(window,Math),L.MarkerGeneralizeGroup=L.FeatureGroup.extend({options:{levels:[{safeZone:20,size:[25,40],offset:[12.5,40],className:"_pin"},{safeZone:5,size:[6,6],className:"_bullet"},{safeZone:0,className:"_hidden"}],checkMarkersIntersection:function(e,t){var s=Math.min(e.safeZone,t.safeZone);return Math.abs(e.x-t.x)>s+e.width/2+t.width/2||Math.abs(e.y-t.y)>s+e.height/2+t.height/2},checkMarkerMinimumLevel:function(){return 0}},initialize:function(e){L.Util.setOptions(this,e),this._layers={},this._markers={},this._priorityMarkers=[],this._otherMarkers=[];for(var t=0;t<this.options.levels.length;t++)this._markers[t]=[];var s,i,o;for(s=0;s<this.options.levels.length;s++)for(o=this.options.levels[s],o.markerOffset=[],o.markerDistance=[],o.size||(o.size=[0,0]),o.offset||(o.offset=[o.size[0]/2,o.size[1]/2]),i=0;2>i;i++)o.markerOffset[i]=o.size[i]/2-o.offset[i]},_addLayer:function(e){e._positions={},e.showAlways?this._priorityMarkers.push(e):this._otherMarkers.push(e),L.LayerGroup.prototype.addLayer.call(this,e)},_prepareMarker:function(e){for(var t,s=this._maxZoom;s>=0;s--)t=this._map.project(e.getLatLng(),s),e._positions[s]=t,e.options.classForZoom=[]},_calculateMarkersClassForEachZoom:function(){this._maxZoom=this._map.getMaxZoom();for(var e=this,t=this._map.getZoom(),s=e._map.getMaxZoom(),i=[],o=1;s>=o;o++)o!=t&&i.push(o);i.sort(function(e,s){return Math.abs(t-e)-Math.abs(t-s)}),this._calculateMarkersClassForZoom(t,function(){L.Util.UnblockingFor(function(t,s){var o=i[t];e._calculateMarkersClassForZoom(o,s)},s-1)})},_calculateMarkersClassForZoom:function(e,t){function s(e,t){function s(t,s){for(var i=r*t;r*(t+1)>i&&c>i;i++)l.options.checkMarkerMinimumLevel(p[i])<=e?(n=o(p[i],a),m=u.retrieve(n),l._validateGroup(n,m)?(u.insert(n),l._markers[e].push(p[i])):f.push(p[i])):f.push(p[i]);s()}function i(){p=f.slice(),f=[],t()}if(a=h.levels[e],0==h.levels[e].size[0]&&0==h.levels[e].size[1])return l._markers[e]=p.slice(),void t();var r=200,c=p.length,_=Math.ceil(c/r);L.Util.UnblockingFor(s,_,i)}function i(){var s,i,o,r,a;for(s=0;s<l.options.levels.length;s++)for(r=l.options.levels[s].className,o=l.options.levels[s],i=0;i<l._markers[s].length;i++)a=l._markers[s][i],a.options.classForZoom[e]=r;l._map.getZoom()==e&&l._invalidateMarkers(),t()}function o(t,s){return{safeZone:s.safeZone,x:t._positions[e].x+s.markerOffset[0],y:t._positions[e].y+s.markerOffset[1],height:s.size[1],width:s.size[0]}}var r,a,n,h=this.options,l=this,c=this._getPixelBoundsForZoom(e);for(r=0;r<h.levels.length;r++)this._markers[r]=[];var u=new L.Util.Quadtree(c);for(a=h.levels[0],r=0;r<this._priorityMarkers.length;r++)n=this._prepareMarker(r),this._markers[a].push(n),u.insert(o(n,a));var m,f=[],p=this._otherMarkers.slice();L.Util.UnblockingFor(s,h.levels.length,i)},_getPixelBoundsForZoom:function(e){var t,s=Number.MAX_VALUE,i=Number.MAX_VALUE,o=0,r=0;return this.eachLayer(function(a){t=a._positions[e],s=Math.min(s,t.x),i=Math.min(i,t.y),o=Math.max(o,t.x),r=Math.max(r,t.y)}),{x:s,y:i,width:o-s,height:r-i}},_validateGroup:function(e,t){if(0==t.length)return!0;var s,i=this.options;for(s=0;s<t.length;s++)if(!i.checkMarkersIntersection(e,t[s]))return!1;return!0},_invalidateMarkers:function(){var e,t=this._map.getZoom();this.eachLayer(function(s){e=s.options.classForZoom[t],e&&s.options.state!=e&&(s.options.state&&L.DomUtil.removeClass(s._icon,s.options.state),L.DomUtil.addClass(s._icon,e),s.options.state=e)},this)},_zoomStart:function(){this._map.getPanes().markerPane.style.display="none"},_zoomEnd:function(){this._invalidateMarkers(),this._map.getPanes().markerPane.style.display="block"},addLayer:function(e){return this._addLayer(e),this._map&&(this._prepareMarker(e),this._calculateMarkersClassForEachZoom(),this._invalidateMarkers()),this},addLayers:function(e){var t;for(t=0;t<e.length;t++)this._addLayer(e[t]);return this._map&&(this.eachLayer(this._prepareMarker,this),this._calculateMarkersClassForEachZoom()),this},_removeLayer:function(e){var t=this._layers.length;return L.LayerGroup.prototype.removeLayer.call(this,e),t-this._layers.length!=0},removeLayer:function(e){return this._removeLayer(e)&&(this._calculateMarkersClassForEachZoom(),this._invalidateMarkers()),this},onAdd:function(e){this._map=e,this._maxZoom=this._map.getMaxZoom(),e.on("zoomstart",this._zoomStart,this),e.on("zoomend",this._zoomEnd,this),this.eachLayer(this._prepareMarker,this),this._calculateMarkersClassForEachZoom(),L.LayerGroup.prototype.onAdd.call(this,e)},onRemove:function(e){this._map&&(e.off("zoomstart",this._zoomStart,this),e.off("zoomend",this._zoomEnd,this),L.LayerGroup.prototype.onRemove.call(this,e),this.eachLayer(function(e){e.options.state=""}),this._map=null)},clearLayers:function(){var e;for(e in this._layers)this._removeLayer(this._layers[e]);for(this._markers={},e=0;e<this.options.levels.length;e++)this._markers[e]=[];return this._priorityMarkers=[],this._otherMarkers=[],this}}),L.markerGeneralizeGroup=function(e){return new L.MarkerGeneralizeGroup(e)},L.Util.UnblockingFor=function(e,t,s){function i(t){setTimeout(function(){e(t,o)},0)}function o(){r++,t>r?i(r):s()}s=s||function(){};var r=0;i(r)};